# 飲食店レコメンドチャットボット概要（最新版）

## 1. 目的

ユーザーの自然文リクエストから **エリア (**``**) を抽出** し、Hot Pepper Gourmet API を用いて

- **ランチにおすすめの 3 店舗**（`lunch=1` で絞り込み）
- **ディナーにおすすめの 3 店舗**（通常検索）

をそれぞれ提示するチャットボットを提供する。ヒットしない場合は条件不足を質問、またはヒットした方のみ案内する。

## 2. 主な技術とライブラリ

| カテゴリ   | 採用技術                                                        |
| ------ | ----------------------------------------------------------- |
| LLM    | **OpenAI GPT‑4o** – クエリ解析 & 回答生成                            |
| フロー制御  | **LangGraph** – 3 ノード構成（parse→fetch→answer）                 |
| 外部 API | **Hot Pepper Gourmet Webサービス** – 飲食店データ取得                   |
| データモデル | **Pydantic v2** – `ChatState`, `SearchParams`, `Restaurant` |

## 3. システムアーキテクチャ

```
ユーザー ─▶ parse_user ─▶ fetch(ランチ/ディナー) ─▶ answer ──┐
          ▲                                          ▲          │
          └──────────────────────────────────────────◀──────────┘ (情報不足時に再質問)
```

- **parse\_user** : LLM で `area` を抽出し、不足時は追加質問を生成。
- **fetch**      : Hot Pepper API を 2 回呼び出し、`lunch=1` と `lunch=0` の結果を `lunch_restaurants` / `dinner_restaurants` に格納（各 3 件）。
- **answer**     : 両リストを要約して返答。片方 0 件の場合は案内メッセージを調整。

## 4. `ChatState` 構成

```python
class ChatState(BaseModel):
    user_query: str
    search_params: SearchParams
    lunch_restaurants:  list[Restaurant]  # ランチ用トップ3
    dinner_restaurants: list[Restaurant]  # ディナー用トップ3
    pending_question: str | None
    response_text:   str | None
```

## 5. 代表的なユーザーストーリー

| ID        | 役割          | ユーザーストーリー                                | 受け入れ条件                                                    |
| --------- | ----------- | ---------------------------------------- | --------------------------------------------------------- |
| **US‑01** | オフィスワーカー    | 「渋谷でランチと夜飲みの両方を比較したい」ので、時間帯別におすすめを確認したい。 | BOT がランチとディナーそれぞれ 3 件ずつ案内する。                              |
| **US‑02** | ランチだけ探すユーザー | 「自由が丘でランチに良いカフェを教えて」                     | `area` 抽出後、ランチ 3 件を提示。ディナー候補が 0 件でもエラーにならない。              |
| **US‑03** | 条件が曖昧なユーザー  | 「安い居酒屋がいい」                               | エリア不足を確認する質問を返す。                                          |
| **US‑04** | 開発者         | 料理ジャンルも加えたい。                             | `SearchParams` に `genre` を追加し、プロンプトと API パラメータを足すだけで拡張可能。 |
| **US‑05** | 運用担当        | 同エリア連続検索のコストを抑えたい。                       | キャッシュ層を入れて 1 時間以内は API 呼び出しをスキップ（拡張要件）。                   |

## 6. シーケンス例

```text
1. ユーザー : "仙台で美味しいお店"
2. parse_user : area="仙台" を抽出
3. fetch      :
   ├─ API① lunch=1   → 3 件取得
   └─ API② lunch=0   → 3 件取得
4. answer     : ランチ / ディナー別に要約して返信
```

## 7. 今後の拡張アイデア

- ジャンル・予算・営業中など複合フィルタ
- 口コミ点数ソート、評価の低い店舗除外
- フロントエンド Carousel 表示 / Google Maps 連携
- Redis キャッシュ・LangSmith ログ連携

---

*Powered by ホットペッパーグルメ Webサービス*

